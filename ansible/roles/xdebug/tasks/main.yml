---
- name: Install xDebug
  apt: pkg=php5-xdebug state=present

- name: Configure xdebug
  template: src=custom_xdebug.tpl dest=/etc/php5/mods-available/custom_xdebug.ini
  notify: restart php5-fpm
  register: xdebug_conf

- name: Symlink xdebug.ini
  file: src="/etc/php5/mods-available/custom_xdebug.ini" dest="/etc/php5/{{ item }}/conf.d/30-custom_xdebug.ini" state=link
  notify: restart php5-fpm
  when: xdebug_conf.changed
  with_items:
    - fpm
    - cli

- name: Check xdebug binary
  shell: ls /usr/local/bin/debug
  ignore_errors: yes
  register: xdebug_bin
  changed_when: False

- name: Xdebug binary
  lineinfile: dest=/usr/local/bin/debug line='#!/bin/sh\nenv PHP_IDE_CONFIG=\"serverName=ongr\" XDEBUG_CONFIG=\"idekey=PHPSTORM\" SYMFONY_DEBUG=\"1\" $@' state=present create=yes owner=root mode=0755
  when: xdebug_bin|failed
